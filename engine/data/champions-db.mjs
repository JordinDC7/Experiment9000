/**
 * CHAMPIONS DB (local, cached)
 *
 * Loads data/champions.json (generated by your bootstrap).
 * Avoids JSON import assertions to prevent the "ExperimentalWarning".
 *
 * Exports:
 *  - getChampionById(id)
 *  - getChampionSummaryById(id)   (small safe payload for IPC/UI)
 *  - getChampionByName(name)
 *  - getChampionSummaryByName(name)
 *  - getChampionByKey(key)
 *  - getChampionSummaryByKey(key)
 */

import fs from "fs";
import path from "path";

let _cache = null; // { version, byId: Map<number, obj>, byName: Map<string, obj>, byKey: Map<string, obj> }
let _cacheMtimeMs = 0;
let _lastErr = null;

const DATA_DIR = path.resolve("data");
const CHAMPS_PATH = path.join(DATA_DIR, "champions.json");

function norm(s) {
  return String(s ?? "")
    .trim()
    .toLowerCase();
}

function loadDb() {
  try {
    const st = fs.statSync(CHAMPS_PATH);
    if (_cache && _cacheMtimeMs === st.mtimeMs) return _cache;

    const raw = fs.readFileSync(CHAMPS_PATH, "utf8");
    const json = JSON.parse(raw);
    const arr = Array.isArray(json?.champions) ? json.champions : [];

    const byId = new Map();
    const byName = new Map();
    const byKey = new Map();

    for (const c of arr) {
      const id = Number(c?.id);
      if (!Number.isFinite(id)) continue;

      const name = String(c?.name ?? "");
      const key = String(c?.key ?? "");

      byId.set(id, c);

      if (name) byName.set(norm(name), c);
      if (key) byKey.set(norm(key), c);
    }

    _cache = { version: json?.version ?? null, byId, byName, byKey };
    _cacheMtimeMs = st.mtimeMs;
    _lastErr = null;
    return _cache;
  } catch (e) {
    _lastErr = String(e);
    _cache = null;
    _cacheMtimeMs = 0;
    return null;
  }
}

export function getChampionById(id) {
  const db = loadDb();
  if (!db) return null;
  const cid = Number(id || 0);
  if (!Number.isFinite(cid) || cid <= 0) return null;
  return db.byId.get(cid) || null;
}

export function getChampionByName(name) {
  const db = loadDb();
  if (!db) return null;
  const k = norm(name);
  if (!k) return null;
  return db.byName.get(k) || null;
}

export function getChampionByKey(key) {
  const db = loadDb();
  if (!db) return null;
  const k = norm(key);
  if (!k) return null;
  return db.byKey.get(k) || null;
}

function summaryFromChampion(c) {
  if (!c) return null;

  const s = c?.stats || {};

  return {
    id: Number(c.id),
    key: String(c.key ?? ""),
    name: String(c.name ?? ""),
    tags: Array.isArray(c.tags) ? c.tags.slice(0, 3) : [],
    stats: {
      hp: s.hp ?? null,
      hpperlevel: s.hpperlevel ?? null,
      mp: s.mp ?? null,
      mpperlevel: s.mpperlevel ?? null,
      movespeed: s.movespeed ?? null,
      armor: s.armor ?? null,
      armorperlevel: s.armorperlevel ?? null,
      spellblock: s.spellblock ?? null,
      spellblockperlevel: s.spellblockperlevel ?? null,
      attackrange: s.attackrange ?? null,
      hpregen: s.hpregen ?? null,
      hpregenperlevel: s.hpregenperlevel ?? null,
      mpregen: s.mpregen ?? null,
      mpregenperlevel: s.mpregenperlevel ?? null,
      crit: s.crit ?? null,
      critperlevel: s.critperlevel ?? null,
      attackdamage: s.attackdamage ?? null,
      attackdamageperlevel: s.attackdamageperlevel ?? null,
      attackspeed: s.attackspeed ?? null,
      attackspeedperlevel: s.attackspeedperlevel ?? null,
    },
  };
}

export function getChampionSummaryById(id) {
  return summaryFromChampion(getChampionById(id));
}

export function getChampionSummaryByName(name) {
  return summaryFromChampion(getChampionByName(name));
}

export function getChampionSummaryByKey(key) {
  return summaryFromChampion(getChampionByKey(key));
}

export function getChampionsDbStatus() {
  const db = loadDb();
  return {
    ok: Boolean(db),
    version: db?.version ?? null,
    count: db?.byId?.size ?? 0,
    path: CHAMPS_PATH,
    lastError: _lastErr,
  };
}
